/*
 * Arethusa - a backend-independent client-side annotation framework
 * http://github.com/alpheios-project/arethusa
 *
 * Version 0.2.5
 * built from branch widget
 * at 0a82a2ad9cc7468ea781bfa023a1dddbd77130c6
 * on 2020-12-07T15:20:56.224Z
 *
 * Published under the MIT license
 */

(function(){function a(a){this.tokens=[],this.tokens.links={},this.options=a||i.defaults,this.rules=j.normal,this.options.gfm&&(this.options.tables?this.rules=j.tables:this.rules=j.gfm)}function b(a,b){if(this.options=b||i.defaults,this.links=a,this.rules=k.normal,this.renderer=this.options.renderer||new c,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.gfm?this.options.breaks?this.rules=k.breaks:this.rules=k.gfm:this.options.pedantic&&(this.rules=k.pedantic)}function c(){}function d(a){this.tokens=[],this.token=null,this.options=a||i.defaults,this.options.renderer=this.options.renderer||new c,this.renderer=this.options.renderer}function e(a,b){return a.replace(b?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function f(a,b){return a=a.source,b=b||"",function c(d,e){return d?(e=e.source||e,e=e.replace(/(^|[^\[])\^/g,"$1"),a=a.replace(d,e),c):new RegExp(a,b)}}function g(){}function h(a){for(var b,c,d=1;d<arguments.length;d++){b=arguments[d];for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a}function i(b,c,f){if(f||"function"==typeof c){f||(f=c,c=null),c=h({},i.defaults,c||{});var g,j,k=c.highlight,l=0;try{g=a.lex(b,c)}catch(a){return f(a)}j=g.length;var m=function(){var a,b;try{a=d.parse(g,c)}catch(a){b=a}return c.highlight=k,b?f(b):f(null,a)};if(!k||k.length<3)return m();if(delete c.highlight,!j)return m();for(;l<g.length;l++)!function(a){"code"!==a.type?--j||m():k(a.text,a.lang,function(b,c){if(null==c||c===a.text)return--j||m();a.text=c,a.escaped=!0,--j||m()})}(g[l])}else try{return c&&(c=h({},i.defaults,c)),d.parse(a.lex(b,c),c)}catch(a){if(a.message+="\nPlease report this to https://github.com/chjj/marked.",(c||i.defaults).silent)return"<p>An error occured:</p><pre>"+e(a.message+"",!0)+"</pre>";throw a}}var j={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:g,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:g,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^\n]+(\n[^\n]+)*\n*)+/,list:/^( *)(bull) [\s\S]+?(?:hr|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment|closed|closing) *(?:\n{2,}|\s*$)/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:g,paragraph:/^((?:[^\n]+\n?(?!hr|heading|lheading|blockquote|tag|def))+)\n*/,text:/^[^\n]+/};j.bullet=/(?:[*+-]|\d+\.)/,j.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/,j.item=f(j.item,"gm")(/bull/g,j.bullet)(),j.list=f(j.list)(/bull/g,j.bullet)("hr",/\n+(?=(?: *[-*_]){3,} *(?:\n+|$))/)(),j._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",j.html=f(j.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,j._tag)(),j.paragraph=f(j.paragraph)("hr",j.hr)("heading",j.heading)("lheading",j.lheading)("blockquote",j.blockquote)("tag","<"+j._tag)("def",j.def)(),j.normal=h({},j),j.gfm=h({},j.normal,{fences:/^ *(`{3,}|~{3,}) *(\S+)? *\n([\s\S]+?)\s*\1 *(?:\n+|$)/,paragraph:/^/}),j.gfm.paragraph=f(j.paragraph)("(?!","(?!"+j.gfm.fences.source.replace("\\1","\\2")+"|"+j.list.source.replace("\\1","\\3")+"|")(),j.tables=h({},j.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/}),a.rules=j,a.lex=function(b,c){return new a(c).lex(b)},a.prototype.lex=function(a){return a=a.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(a,!0)},a.prototype.token=function(a,b){for(var c,d,e,f,g,h,i,k,l,a=a.replace(/^ +$/gm,"");a;)if((e=this.rules.newline.exec(a))&&(a=a.substring(e[0].length),e[0].length>1&&this.tokens.push({type:"space"})),e=this.rules.code.exec(a))a=a.substring(e[0].length),e=e[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",text:this.options.pedantic?e:e.replace(/\n+$/,"")});else if(e=this.rules.fences.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"code",lang:e[2],text:e[3]});else if(e=this.rules.heading.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"heading",depth:e[1].length,text:e[2]});else if(b&&(e=this.rules.nptable.exec(a))){for(a=a.substring(e[0].length),h={type:"table",header:e[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3].replace(/\n$/,"").split("\n")},k=0;k<h.align.length;k++)/^ *-+: *$/.test(h.align[k])?h.align[k]="right":/^ *:-+: *$/.test(h.align[k])?h.align[k]="center":/^ *:-+ *$/.test(h.align[k])?h.align[k]="left":h.align[k]=null;for(k=0;k<h.cells.length;k++)h.cells[k]=h.cells[k].split(/ *\| */);this.tokens.push(h)}else if(e=this.rules.lheading.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"heading",depth:"="===e[2]?1:2,text:e[1]});else if(e=this.rules.hr.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"hr"});else if(e=this.rules.blockquote.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"blockquote_start"}),e=e[0].replace(/^ *> ?/gm,""),this.token(e,b),this.tokens.push({type:"blockquote_end"});else if(e=this.rules.list.exec(a)){for(a=a.substring(e[0].length),f=e[2],this.tokens.push({type:"list_start",ordered:f.length>1}),e=e[0].match(this.rules.item),c=!1,l=e.length,k=0;k<l;k++)h=e[k],i=h.length,h=h.replace(/^ *([*+-]|\d+\.) +/,""),~h.indexOf("\n ")&&(i-=h.length,h=this.options.pedantic?h.replace(/^ {1,4}/gm,""):h.replace(new RegExp("^ {1,"+i+"}","gm"),"")),this.options.smartLists&&k!==l-1&&(g=j.bullet.exec(e[k+1])[0],f===g||f.length>1&&g.length>1||(a=e.slice(k+1).join("\n")+a,k=l-1)),d=c||/\n\n(?!\s*$)/.test(h),k!==l-1&&(c="\n"===h.charAt(h.length-1),d||(d=c)),this.tokens.push({type:d?"loose_item_start":"list_item_start"}),this.token(h,!1),this.tokens.push({type:"list_item_end"});this.tokens.push({type:"list_end"})}else if(e=this.rules.html.exec(a))a=a.substring(e[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:"pre"===e[1]||"script"===e[1]||"style"===e[1],text:e[0]});else if(b&&(e=this.rules.def.exec(a)))a=a.substring(e[0].length),this.tokens.links[e[1].toLowerCase()]={href:e[2],title:e[3]};else if(b&&(e=this.rules.table.exec(a))){for(a=a.substring(e[0].length),h={type:"table",header:e[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:e[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:e[3].replace(/(?: *\| *)?\n$/,"").split("\n")},k=0;k<h.align.length;k++)/^ *-+: *$/.test(h.align[k])?h.align[k]="right":/^ *:-+: *$/.test(h.align[k])?h.align[k]="center":/^ *:-+ *$/.test(h.align[k])?h.align[k]="left":h.align[k]=null;for(k=0;k<h.cells.length;k++)h.cells[k]=h.cells[k].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */);this.tokens.push(h)}else if(b&&(e=this.rules.paragraph.exec(a)))a=a.substring(e[0].length),this.tokens.push({type:"paragraph",text:"\n"===e[1].charAt(e[1].length-1)?e[1].slice(0,-1):e[1]});else if(e=this.rules.text.exec(a))a=a.substring(e[0].length),this.tokens.push({type:"text",text:e[0]});else if(a)throw new Error("Infinite loop on byte: "+a.charCodeAt(0));return this.tokens};var k={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:g,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:g,text:/^[\s\S]+?(?=[\\<!\[_*`]| {2,}\n|$)/};k._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,k._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,k.link=f(k.link)("inside",k._inside)("href",k._href)(),k.reflink=f(k.reflink)("inside",k._inside)(),k.normal=h({},k),k.pedantic=h({},k.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),k.gfm=h({},k.normal,{escape:f(k.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:f(k.text)("]|","~]|")("|","|https?://|")()}),k.breaks=h({},k.gfm,{br:f(k.br)("{2,}","*")(),text:f(k.gfm.text)("{2,}","*")()}),b.rules=k,b.output=function(a,c,d){return new b(c,d).output(a)},b.prototype.output=function(a){for(var b,c,d,f,g="";a;)if(f=this.rules.escape.exec(a))a=a.substring(f[0].length),g+=f[1];else if(f=this.rules.autolink.exec(a))a=a.substring(f[0].length),"@"===f[2]?(c=":"===f[1].charAt(6)?this.mangle(f[1].substring(7)):this.mangle(f[1]),d=this.mangle("mailto:")+c):(c=e(f[1]),d=c),g+=this.renderer.link(d,null,c);else if(f=this.rules.url.exec(a))a=a.substring(f[0].length),c=e(f[1]),d=c,g+=this.renderer.link(d,null,c);else if(f=this.rules.tag.exec(a))a=a.substring(f[0].length),g+=this.options.sanitize?e(f[0]):f[0];else if(f=this.rules.link.exec(a))a=a.substring(f[0].length),g+=this.outputLink(f,{href:f[2],title:f[3]});else if((f=this.rules.reflink.exec(a))||(f=this.rules.nolink.exec(a))){if(a=a.substring(f[0].length),b=(f[2]||f[1]).replace(/\s+/g," "),!(b=this.links[b.toLowerCase()])||!b.href){g+=f[0].charAt(0),a=f[0].substring(1)+a;continue}g+=this.outputLink(f,b)}else if(f=this.rules.strong.exec(a))a=a.substring(f[0].length),g+=this.renderer.strong(this.output(f[2]||f[1]));else if(f=this.rules.em.exec(a))a=a.substring(f[0].length),g+=this.renderer.em(this.output(f[2]||f[1]));else if(f=this.rules.code.exec(a))a=a.substring(f[0].length),g+=this.renderer.codespan(e(f[2],!0));else if(f=this.rules.br.exec(a))a=a.substring(f[0].length),g+=this.renderer.br();else if(f=this.rules.del.exec(a))a=a.substring(f[0].length),g+=this.renderer.del(this.output(f[1]));else if(f=this.rules.text.exec(a))a=a.substring(f[0].length),g+=e(this.smartypants(f[0]));else if(a)throw new Error("Infinite loop on byte: "+a.charCodeAt(0));return g},b.prototype.outputLink=function(a,b){var c=e(b.href),d=b.title?e(b.title):null;return"!"!==a[0].charAt(0)?this.renderer.link(c,d,this.output(a[1])):this.renderer.image(c,d,e(a[1]))},b.prototype.smartypants=function(a){return this.options.smartypants?a.replace(/--/g,"—").replace(/(^|[-\u2014\/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014\/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…"):a},b.prototype.mangle=function(a){for(var b,c="",d=a.length,e=0;e<d;e++)b=a.charCodeAt(e),Math.random()>.5&&(b="x"+b.toString(16)),c+="&#"+b+";";return c},c.prototype.code=function(a,b,c,d){if(d=d||{},d.highlight){var f=d.highlight(a,b);null!=f&&f!==a&&(c=!0,a=f)}return b?'<pre><code class="'+d.langPrefix+b+'">'+(c?a:e(a))+"\n</code></pre>\n":"<pre><code>"+(c?a:e(a,!0))+"\n</code></pre>"},c.prototype.blockquote=function(a){return"<blockquote>\n"+a+"</blockquote>\n"},c.prototype.html=function(a){return a},c.prototype.heading=function(a,b,c,d){return"<h"+b+' id="'+d.headerPrefix+c.toLowerCase().replace(/[^\w]+/g,"-")+'">'+a+"</h"+b+">\n"},c.prototype.hr=function(){return"<hr>\n"},c.prototype.list=function(a,b){var c=b?"ol":"ul";return"<"+c+">\n"+a+"</"+c+">\n"},c.prototype.listitem=function(a){return"<li>"+a+"</li>\n"},c.prototype.paragraph=function(a){return"<p>"+a+"</p>\n"},c.prototype.table=function(a,b){return"<table>\n<thead>\n"+a+"</thead>\n<tbody>\n"+b+"</tbody>\n</table>\n"},c.prototype.tablerow=function(a){return"<tr>\n"+a+"</tr>\n"},c.prototype.tablecell=function(a,b){var c=b.header?"th":"td";return(b.align?"<"+c+' style="text-align:'+b.align+'">':"<"+c+">")+a+"</"+c+">\n"},c.prototype.strong=function(a){return"<strong>"+a+"</strong>"},c.prototype.em=function(a){return"<em>"+a+"</em>"},c.prototype.codespan=function(a){return"<code>"+a+"</code>"},c.prototype.br=function(){return"<br>"},c.prototype.del=function(a){return"<del>"+a+"</del>"},c.prototype.link=function(a,b,c){var d='<a href="'+a+'"';return b&&(d+=' title="'+b+'"'),d+=">"+c+"</a>"},c.prototype.image=function(a,b,c){var d='<img src="'+a+'" alt="'+c+'"';return b&&(d+=' title="'+b+'"'),d+=">"},d.parse=function(a,b,c){return new d(b,c).parse(a)},d.prototype.parse=function(a){this.inline=new b(a.links,this.options,this.renderer),this.tokens=a.reverse();for(var c="";this.next();)c+=this.tok();return c},d.prototype.next=function(){return this.token=this.tokens.pop()},d.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},d.prototype.parseText=function(){for(var a=this.token.text;"text"===this.peek().type;)a+="\n"+this.next().text;return this.inline.output(a)},d.prototype.tok=function(){switch(this.token.type){case"space":return"";case"hr":return this.renderer.hr();case"heading":return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,this.token.text,this.options);case"code":return this.renderer.code(this.token.text,this.token.lang,this.token.escaped,this.options);case"table":var a,b,c,d,e="",f="";for(c="",a=0;a<this.token.header.length;a++)({header:!0,align:this.token.align[a]}),c+=this.renderer.tablecell(this.inline.output(this.token.header[a]),{header:!0,align:this.token.align[a]});for(e+=this.renderer.tablerow(c),a=0;a<this.token.cells.length;a++){for(b=this.token.cells[a],c="",d=0;d<b.length;d++)c+=this.renderer.tablecell(this.inline.output(b[d]),{header:!1,align:this.token.align[d]});f+=this.renderer.tablerow(c)}return this.renderer.table(e,f);case"blockquote_start":for(var f="";"blockquote_end"!==this.next().type;)f+=this.tok();return this.renderer.blockquote(f);case"list_start":for(var f="",g=this.token.ordered;"list_end"!==this.next().type;)f+=this.tok();return this.renderer.list(f,g);case"list_item_start":for(var f="";"list_item_end"!==this.next().type;)f+="text"===this.token.type?this.parseText():this.tok();return this.renderer.listitem(f);case"loose_item_start":for(var f="";"list_item_end"!==this.next().type;)f+=this.tok();return this.renderer.listitem(f);case"html":var h=this.token.pre||this.options.pedantic?this.token.text:this.inline.output(this.token.text);return this.renderer.html(h);case"paragraph":return this.renderer.paragraph(this.inline.output(this.token.text));case"text":return this.renderer.paragraph(this.parseText())}},g.exec=g,i.options=i.setOptions=function(a){return h(i.defaults,a),i},i.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:"",renderer:new c},i.Parser=d,i.parser=d.parse,i.Renderer=c,i.Lexer=a,i.lexer=a.lex,i.InlineLexer=b,i.inlineLexer=b.output,i.parse=i,"object"==typeof exports?module.exports=i:"function"==typeof define&&define.amd?define(function(){return i}):this.marked=i}).call(function(){return this||("undefined"!=typeof window?window:global)}()),angular.module("yaru22.md",[]).directive("md",function(){return"undefined"!=typeof hljs&&marked.setOptions({highlight:function(a,b){return b?hljs.highlight(b,a).value:hljs.highlightAuto(a).value}}),{restrict:"E",require:"?ngModel",link:function(a,b,c,d){if(!d){var e=marked(b.text());return void b.html(e)}d.$render=function(){var a=marked(d.$viewValue||"");b.html(a)}}}}),angular.module("arethusa.comments",["yaru22.md"]),angular.module("arethusa.comments").directive("comment",["comments",function(a){return{restrict:"A",scope:{comment:"="},link:function(a,b,c){},templateUrl:"js/arethusa.comments/templates/comment.html"}}]),angular.module("arethusa.comments").directive("commentCreator",["comments","state",function(a,b,c,d,e){return{restrict:"A",scope:{},link:function(c,d,e){function f(){return c.active?"on "+b.toTokenStrings(c.ids):""}var g;c.comments=a,c.state=b,c.hasSelections=b.hasClickSelections,c.$watchCollection("state.clickedTokens",function(a,b){c.ids=Object.keys(a).sort(),c.active=c.ids.length,c.currentTokenStrings=f()}),c.submit=function(){a.createNewComment(g,c.comment)}},templateUrl:"js/arethusa.comments/templates/comment_creator.html"}}]),angular.module("arethusa.comments").directive("commentFilter",["comments","state","translator",function(a,b,c){return{restrict:"A",scope:{},link:function(d,e,f){function g(){angular.forEach(d.ids,function(a,c){b.addStyle(a,i)})}function h(){angular.forEach(d.ids,function(a,c){var d=Object.keys(i);b.removeStyle(a,d)})}var i={"background-color":"rgb(142, 255, 142)"};d.comments=a,d.total=b.totalTokens,d.filter=a.filter;var j;d.highlightCommented=function(){j?h():g(),j=!j},d.selectCommented=function(){h(),b.multiSelect(d.ids)},d.$watchCollection("comments.reverseIndex",function(a,b){d.ids=Object.keys(a),d.count=d.ids.length}),c("uth.tooltip",function(a){d.tooltip=a()})},templateUrl:"js/arethusa.comments/templates/comment_filter.html"}}]),angular.module("arethusa.comments").directive("commentInputForm",["comments","translator",function(a,b){return{restrict:"A",scope:{active:"=commentInputForm",target:"="},link:function(c,d,e){function f(a){c.markdownPlaceholder=a()}c.submit=function(){a.createNewComment(c.target,c.comment,function(){c.comment=""})},b("markdownEnabled",f)},templateUrl:"js/arethusa.comments/templates/comment_input_form.html"}}]),angular.module("arethusa.comments").directive("commentTargets",["comments","idHandler",function(a,b){return{restrict:"A",scope:{tokens:"=commentTargets"},link:function(a,c,d){function e(){return arethusaUtil.map(a.tokens,function(a){return a.id}).sort()}a.nonSequential=b.nonSequentialIds(e())},templateUrl:"js/arethusa.comments/templates/comment_targets.html"}}]),angular.module("arethusa.comments").directive("commentsX",["comments","state",function(a,b){return{restrict:"A",scope:{comments:"=commentsX"},compile:function(a,c,d){return{pre:function(a,c,d){a.tokens=arethusaUtil.map(a.comments.ids,function(a){return b.getToken(a)})},post:function(a,c,d){a.select=function(){b.multiSelect(a.comments.ids)}}}},templateUrl:"js/arethusa.comments/templates/comments.directive.html"}}]),angular.module("arethusa.comments").directive("commentsOnDocLevel",["comments",function(a){return{restrict:"A",scope:{},link:function(b,c,d){b.c=a,b.count=function(){return a.docLevelComments.length}},templateUrl:"js/arethusa.comments/templates/comments_on_doc_level.html"}}]),angular.module("arethusa.comments").factory("CommentsRetriever",["configurator","idHandler","state",function(a,b,c){function d(a){var b=e(a),c=a.slice(0,b-1),d=a.slice(b),f=new RegExp("^##(.*?)##"),g=f.exec(c);return g?[g[1],d]:[null,a]}function e(a){var b=a.indexOf("#!#\n\n");return-1===b?a.indexOf("##\n\n")+4:b+5}function f(a,b){this.ids=a,this.comments=[b]}function g(a,c){if(!a)return o.document.push(c);var d=a.split("."),e=d[0],g=arethusaUtil.map(d[1].split(","),function(a){return b.getId(a,e)}),i=arethusaUtil.getProperty(o,e);i||(i=[],arethusaUtil.setProperty(o,e,i));var j=h(i,g);return j?j.comments.push(c):(j=new f(g,c),i.unshift(j)),j}function h(a,b){for(var c,d=0;d<a.length;d++){var e=a[d];if(angular.equals(e.ids,b)){c=e;break}}return c}function i(a,b){var c=a.comment,e=d(c);return a.comment=e[1],g(e[0],a)}function j(a){angular.forEach(a,i),l()}function k(a,b){o[b]=a.sort(function(a,b){return a.ids>b.ids})}function l(){angular.forEach(o,k)}function m(a){var d=a.sentenceId,e=a.ids,f=arethusaUtil.map(e,function(a){return b.formatId(a,"%w")}),g="##"+d+"."+f.join(",")+"##\n\n",h="#!# "+c.toTokenStrings(e)+" #!#\n\n";a.comment=g+h+a.comment}var n,o={document:[]};return function(b){var c=a.provideResource(b.resource);this.getData=function(a,b){n?b(o[a]):(c.get().then(function(c){j(c.data),b(o[a]||[])}),n=!0)},this.saveData=function(a,b,d){m(a),c.save(a).then(function(a){b(i(a.data))},d)},this.docLevelComments=function(){return o.document}}}]),angular.module("arethusa.comments").service("comments",["state","configurator","navigator","notifier","plugins","keyCapture","translator",function(a,b,c,d,e,f,g){function h(){b.getConfAndDelegate(v),w=b.getRetriever(v.conf.retriever),x=w}function i(){v.comments=[],v.docLevelComments=[],w&&w.getData(c.status.currentIds[0],function(a){v.comments=a,v.docLevelComments=w.docLevelComments(),j()})}function j(){y={},v.reverseIndex={},z=k(),angular.forEach(v.comments,l)}function k(){return lunr(function(){this.field("body"),this.ref("id")})}function l(a){var b=a.ids,c=b.join("|");y[c]=a,z.add({id:c,body:m(a)}),angular.forEach(b,function(a){arethusaUtil.setProperty(v.reverseIndex,a+"."+c,!0)})}function m(a){return arethusaUtil.map(a.comments,function(a){return a.comment}).join(" ")}function n(){var a=v.filter.selection,b=v.filter.fullText;if(a||b){var c;return a&&(c=o()),b&&(c=p(b,c)),q(c)}}function o(){var b={};return angular.forEach(a.selectedTokens,function(a,c){angular.extend(b,v.reverseIndex[c])}),Object.keys(b).sort()}function p(a,b){if(b&&!b.length)return b;var c=z.search(a),d=arethusaUtil.map(c,function(a){return a.ref});return b?arethusaUtil.intersect(d,b):d}function q(a){return arethusaUtil.map(a,function(a){return y[a]})}function r(a,b,c,d){this.ids=a,this.sentenceId=b,this.comment=c}function s(a){return function(b){0!==v.comments.length?l(b):i(),a(),d.success(A.success())}}function t(){d.error(A.error())}function u(){a.hasClickSelections()?(v.creator=!0,e.setActive(v)):d.info(A.selectFirst())}var v=this;this.name="comments";var w,x,y,z,A=g({"comments.successMessage":"success","comments.errorMessage":"error","comments.selectFirst":"selectFirst"});this.externalDependencies=["https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.5.12/lunr.min.js"],this.filter={},this.reverseIndex={},this.defaultConf={template:"js/arethusa.comments/templates/comments.html",contextMenu:!0,contextMenuTemplate:"js/arethusa.comments/templates/context_menu.html"},this.init=function(){h(),i()},this.commentCountFor=function(a){var b=0,c=v.reverseIndex[a.id];if(c){var d=Object.keys(c);angular.forEach(q(d),function(a){b+=a.comments.length})}return b},this.goToComments=function(b){a.deselectAll(),a.selectToken(b),v.filter.selection=!0,v.filter.fullText="",e.setActive(v)},this.currentComments=function(){return n()||v.comments},this.createNewComment=function(a,b,d){var e=new r(a,c.status.currentIds[0],b);x.saveData(e,s(d),t)},f.initCaptures(function(a){return{comments:[a.create("create",u,"ctrl-K")]}})}]),angular.module("arethusa.comments").run(["$templateCache",function(a){"use strict";a.put("js/arethusa.comments/templates/comment.html",'<div class="comment">\n  <div class="comment-header">\n    <span><strong>{{ comment.user }}</strong></span>\n    <span class="right note">{{ comment.updated_at | date: \'short\' }}</span>\n  </div>\n  <div class="comment-body">\n    <md ng-model="comment.comment"/>\n  </div>\n</div>\n'),a.put("js/arethusa.comments/templates/comment_creator.html",'<div>\n  <div delimiter/>\n  <div>\n    <span\n      ng-click="comments.creator = (!comments.creator && active)"\n      ng-disabled="!active"\n      class="button radius micro"\n      translate="comments.newComment">\n    </span>\n    <span class="italic">{{ currentTokenStrings }}</span>\n  </div>\n  <p>\n    <div comment-input-form="comments.creator" target="ids">\n  </p>\n</div>\n'),a.put("js/arethusa.comments/templates/comment_filter.html",'<div class="small-12 columns">\n  <label>\n    <span translate="comments.fullTextSearch"/>\n    <input\n      type="search"\n      style="margin: 0"\n      ng-model="filter.fullText"/>\n  </label>\n<div class="small-6 columns">\n  <label>\n    <span translate="comments.filterSelected"/>\n    <input\n      type="checkbox"\n      style="margin: 0"\n      ng-model="filter.selection"/>\n  </label>\n</div>\n<div class="small-6 columns">\n  <label\n    class="right clickable"\n    tooltip-html-unsafe="{{ tooltip }}"\n    tooltip-popup-delay="700"\n    tooltip-placement="left"\n    ng-click="highlightCommented()"\n    ng-dblclick="selectCommented()">\n    <span\n      translate="comments.count"\n      translate-value-count="{{ count }}"\n      translate-value-total="{{ total }}"/>\n  </label>\n</div>\n'),a.put("js/arethusa.comments/templates/comment_input_form.html",'<form ng-if="active">\n  \x3c!-- ngIf opens a new scope - we therefore need a --\x3e\n  \x3c!-- parent reference in our model --\x3e\n  <textarea\n    focus-me="active"\n    rows="3"\n    placeholder="{{ markdownPlaceholder}}"\n    ng-model="$parent.comment"/>\n  <span\n    ng-disabled="!comment"\n    ng-click="submit()"\n    class="button micro radius"\n    translate="submit">\n  </span>\n</form>\n'),a.put("js/arethusa.comments/templates/comment_targets.html",'<span translate="comments.on"/>\n<span ng-repeat="token in tokens">\n  <span\n    class="normal-size"\n    token="token"\n    colorize="true"\n    click="true"\n    hover="true">\n  </span>\n  <span>\n  <span ng-if="nonSequential[$index]">\n    ...\n  </span>\n</span>\n'),a.put("js/arethusa.comments/templates/comments.directive.html",'<div class="comments">\n  <div class="italic">\n    <span comment-targets="tokens"/>\n    <span class="right">\n      <span class="button nano radius success"\n        ng-click="inputOpen = !inputOpen">\n        <i class="fa fa-reply"></i>\n      </span>\n      <span class="button nano radius"\n        ng-click="select()">\n        <i class="fa fa-crosshairs"></i>\n      </span>\n    </span>\n  </div>\n  <div\n    class="fade-in"\n    ng-repeat="comment in comments.comments"\n    comment="comment"/>\n  <div class="text-center">\n    <div comment-input-form="inputOpen" target="comments.ids"/>\n    <span class="ornament-delimiter" style="margin-top: 0.5rem"/>\n  </div>\n</div>\n'),a.put("js/arethusa.comments/templates/comments.html",'<div comment-filter/>\n<div comment-creator/>\n<hr class="small"/>\n<div\n  class="fade-in"\n  ng-repeat="comments in plugin.currentComments()"\n  comments-x="comments">\n</div>\n<div delimiter/>\n<div comments-on-doc-level/>\n'),a.put("js/arethusa.comments/templates/comments_on_doc_level.html",'<div ng-if="count()" class="comments">\n  <div ng-click="visible = !visible">\n    <span class="italic clickable">\n      <span translate="comments.docLevelComm"/>\n      <span>({{ count() }})</span>\n    </span>\n  </div>\n  <div delimiter/>\n  <div ng-if="visible" class="fade fast">\n    <div ng-repeat="comment in c.docLevelComments" comment="comment"/>\n  </div>\n</div>\n'),a.put("js/arethusa.comments/templates/context_menu.html",'<div>\n  <span\n    class="clickable"\n    ng-click="plugin.goToComments(token.id)"\n    ng-pluralize count="plugin.commentCountFor(token)"\n'+"    when=\"{ '0': 'No comments', 'one': '1 comment', 'other': '{} comments'}\">\n </span>\n</div>\n")}]);
//# sourceMappingURL=arethusa.comments.min.map